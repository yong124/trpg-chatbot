# TRPG AI 챗봇 배포 과정 및 문제 해결 요약

이 문서는 TRPG AI 챗봇 프로젝트를 로컬 개발 환경에서 웹에 성공적으로 배포하고, 이후 발생한 버그들을 해결한 전체 과정을 기록합니다.

## 1. 초기 배포 목표

-   **애플리케이션:** Flask 백엔드와 순수 JavaScript 프론트엔드로 구성된 TRPG 챗봇.
-   **배포 플랫폼:** Render.com
-   **전략:** 백엔드는 'Web Service'로, 프론트엔드는 'Static Site'로 분리하여 배포.

## 2. 배포 준비 단계

-   **백엔드 준비:** 운영 환경에서 안정적인 실행을 위해 `gunicorn`을 `requirements.txt`에 추가.
-   **프론트엔드 준비:** 로컬 주소(`localhost`)로 고정된 API 호출 주소를, 배포 시 유연하게 변경할 수 있도록 `window.BACKEND_API_BASE_URL` 변수를 사용하도록 `script.js` 수정.

## 3. GitHub 업로드 과정

-   **문제 발생:** GitHub 웹사이트에서 폴더 직접 업로드가 불가능한 문제 발생.
-   **해결:** **GitHub Desktop** 프로그램을 사용하여 로컬의 프로젝트 폴더 전체를 GitHub 저장소에 업로드(Push)하는 것으로 해결.
-   **보안 조치:** 사용자의 API 키가 포함된 `api_key.env` 파일이 GitHub에 올라가지 않도록, 프로젝트 루트에 `.gitignore` 파일을 생성하여 해당 파일을 명시적으로 제외함.

## 4. 백엔드 배포 (Render Web Service)

백엔드 배포 과정에서 여러 번의 배포 실패를 겪었으며, 원인과 해결 과정은 다음과 같다.

### 4.1. 1차 실패: `ModuleNotFoundError`
-   **원인:** `requirements.txt` 파일에 `google-generativeai`와 `python-dotenv` 라이브러리가 누락되어, 서버가 실행에 필요한 모듈을 찾지 못함.
-   **해결:** `requirements.txt`에 누락된 두 라이브러리를 추가하고 재배포.

### 4.2. 2차 실패: `FileNotFoundError`
-   **원인:** `app.py` 코드 내에 `debug.log`, `lorebook.md` 등의 파일 경로가 `backend/` 접두사를 포함하고 있었음. Render는 실행 기준 디렉토리를 `backend`로 설정했기 때문에, `backend/backend/debug.log` 와 같은 잘못된 경로를 찾으려 시도함.
-   **해결:** `app.py` 내의 모든 파일 경로에서 불필요한 `backend/` 접두사를 제거하고 재배포.

**-> 위 문제 해결 후 백엔드 배포 성공.**

## 5. 프론트엔드 배포 (Render Static Site)

-   **백엔드 연결:** 성공적으로 배포된 백엔드 URL(`https://trpg-chatbot.onrender.com`)을 `frontend/index.html` 파일에 `<script>` 태그로 삽입하여 `window.BACKEND_API_BASE_URL` 변수에 할당.
-   **Render 설정:** `Root Directory`를 비워두고 `Publish Directory`를 `frontend`로 설정하여 경로 문제 해결.

## 6. 배포 후 버그 수정

### 6.1. 레이아웃 버그: 사이드바 너비 축소
-   **증상:** 채팅창에 긴 내용이 입력되면 왼쪽 사이드바의 너비가 쪼그라드는 현상.
-   **원인 분석:**
    1.  초기에는 `style.css` 파일을 수정했으나, 실제 스타일은 `index.html` 내의 `<style>` 태그에 있었음을 뒤늦게 파악함 (핵심 실수).
    2.  Flexbox 레이아웃에서, 내용이 길어진 자식 요소(`chat-area`)가 부모가 허용한 공간 이상으로 확장하려 하면서, 옆에 있던 다른 자식 요소(`sidebar`)를 강제로 축소시키는 문제.
-   **해결:** `index.html` 파일 내부의 `<style>` 태그를 직접 수정.
    1.  `#sidebar`에 `flex-shrink: 0;` 속성을 추가하여 너비가 줄어들지 않도록 강제.
    2.  `#chat-area`에 `min-width: 0;` 속성을 추가하여 내용물이 부모를 넘어서는 것을 방지.

### 6.2. 데이터 버그: 캐릭터 정보 초기화
-   **증상:** 배포된 사이트에서 캐릭터 생성 후 첫 채팅을 입력하면, 캐릭터 정보가 기본값(능력치 1,1,1,1,1)으로 초기화됨.
-   **원인:** 프론트엔드와 백엔드의 도메인이 달라, 브라우저의 `SameSite` 쿠키 보안 정책에 의해 세션 쿠키 전송이 차단됨. 이로 인해 백엔드가 사용자를 식별하지 못하고 기본 캐릭터 정보를 반환함.
-   **해결:** `app.py`에 Flask 앱 설정을 추가하여, 세션 쿠키가 다른 도메인 간에도 안전하게 전송될 수 있도록 `SESSION_COOKIE_SAMESITE='None'`와 `SESSION_COOKIE_SECURE=True` 옵션을 설정함.

### 6.3. 데이터 버그: 로어북 초기 설정 미적용 문제 디버깅
-   **문제 상황:** `trpg-chatbot` 프로젝트 배포 후, 캐릭터 생성 시 `lorebook.md`에 정의된 '시작 위치', '시작 상황' 등의 초기 설정이 적용되지 않음.
-   **증상:** 프론트엔드에는 "알 수 없는 장소", "알 수 없는 상황" 등 기본값만 표시됨.
-   **진행 과정:**
    1.  **1차 진단: 실행 경로 문제**
        - `debug.log`에서 `lorebook.md not found` 경고를 확인함.
        - 원인: `app.py` 실행 위치에 따라 상대 경로(`'lorebook.md'`)가 유효하지 않은 것으로 판단.
        - **조치:** `app.py`에서 `os.path.abspath`를 사용하여 파일의 절대 경로를 찾도록 `LOREBOOK_PATH` 설정을 수정함.
        - **결과:** 조치 후에도 배포 환경에서 문제 해결되지 않음.

    2.  **2차 진단: 프론트엔드 로직 오류 가능성**
        - `index.html`과 `script.js` 파일의 데이터 처리 로직을 검토.
        - `script.js`의 `updateCharacterUI` 함수에서, 서버로부터 받은 location, state 값이 비어있을 경우 `|| '알 수 없음'` 로직에 의해 기본값이 표시되는 것을 확인.
        - 이를 통해 백엔드가 로어북 데이터를 제대로 읽었으나, 프론트엔드로 보내는 과정에서 데이터가 누락되거나 비어있을 수 있다는 가설을 세움.

    3.  **3차 진단: 백엔드 파싱 로직 불안정성**
        - `app.py`의 `parse_lorebook` 함수가 특정 조건에서 '시작 설정'의 키-값 쌍을 제대로 추출하지 못할 가능성을 의심.
        - **조치:** 기존의 문자열 분리(`split`) 방식 대신, 더 안정적인 정규식(regex)을 사용하여 키-값을 추출하도록 파싱 로직을 강화함.
        - **결과:** 로직 강화 후에도 문제 해결되지 않음.

    4.  **최종 진단 및 현재 상태: 근본 원인 추적을 위한 로그 추가**
        - 이전의 모든 조치가 실패함에 따라, 가장 근본적인 원인인 **"LOREBOOK_DATA 변수 자체가 비어있다"**는 가설을 최종적으로 검증하기로 함.
        - `try...except` 구문 때문에 파일 읽기/파싱 실패가 조용히 무시되고 있을 가능성이 매우 높음.
        - **조치:** `/create-character` 함수 내부에, **캐릭터 생성 요청이 들어오는 순간의 `LOREBOOK_DATA`와 `start_settings` 변수의 실제 내용을 직접 확인**하기 위한 디버깅용 로그 출력 코드를 삽입함.
        - **현재 상태:** 사용자가 디버깅 코드가 포함된 `app.py`를 재배포하고, 캐릭터 생성 후 발생하는 로그를 확인하여 공유해주기를 기다리는 중. 이 로그를 통해 문제의 근본 원인을 명확히 특정할 수 있을 것으로 기대.

---
*이 문서는 향후 유지보수를 위해 작성되었습니다.*